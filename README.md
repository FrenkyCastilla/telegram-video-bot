# Telegram Video Bot

Telegram-бот для автоматической обработки видео встреч: конвертация, транскрибация и генерация саммари.

## Возможности

- ✅ Работа в групповых чатах и темах (threads)
- ✅ Поддержка различных видео и аудио форматов (.webm, .mp4, .mp3, .wav, .flac и др.)
- ✅ Автоматическая конвертация в MP3 через ffmpeg
- ✅ Транскрибация речи через Fireworks Whisper v3 API
- ✅ Генерация структурированного саммари через OpenAI GPT-4.1-nano
- ✅ Форматированный Markdown-ответ с результатами
- ✅ Логирование всех операций
- ✅ Обработка ошибок с ретраями
- ✅ Docker-контейнеризация

## Требования

- Python 3.11+
- FFmpeg
- Telegram Bot Token
- Fireworks API Key
- OpenAI API Key

## Быстрый старт

### 1. Клонирование и настройка

```bash
# Создайте .env файл на основе примера
cp .env.example .env

# Отредактируйте .env и добавьте ваши токены
nano .env
```

### 2. Настройка переменных окружения

Отредактируйте `.env` файл:

```env
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
FIREWORKS_API_KEY=your_fireworks_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
TARGET_THREAD_ID=  # Опционально: ID конкретной темы
LOG_LEVEL=INFO
```

### 3. Запуск с Docker (рекомендуется)

```bash
# Сборка и запуск
docker-compose up -d

# Просмотр логов
docker-compose logs -f

# Остановка
docker-compose down
```

### 4. Запуск без Docker

```bash
# Установка зависимостей
pip install -r requirements.txt

# Убедитесь, что ffmpeg установлен
# Ubuntu/Debian:
sudo apt-get install ffmpeg

# macOS:
brew install ffmpeg

# Запуск бота
python main.py
```

## Использование

### Основные команды

- `/start` - Приветственное сообщение и инструкции
- `/help` - Справка по использованию
- `/summary` - Повторная генерация саммари по последней транскрибации

### Обработка файлов

1. Добавьте бота в группу или начните диалог
2. Отправьте видео или аудио файл
3. Бот автоматически:
   - Скачает файл
   - Конвертирует в MP3 (если нужно)
   - Транскрибирует речь
   - Сгенерирует саммари
   - Отправит результат в ответном сообщении

### Работа с темами (threads)

Если вы хотите, чтобы бот работал только в определенной теме:

1. Найдите ID темы (можно через Telegram API или боты-помощники)
2. Укажите `TARGET_THREAD_ID` в `.env` файле
3. Бот будет игнорировать сообщения из других тем

## Структура проекта

```
telegram-video-bot/
├── main.py              # Точка входа приложения
├── config.py            # Конфигурация и переменные окружения
├── logger.py            # Настройка логирования
├── handlers.py          # Обработчики сообщений Telegram
├── api_client.py        # Клиенты для Fireworks и OpenAI API
├── utils.py             # Вспомогательные функции (конвертация и др.)
├── requirements.txt     # Python зависимости
├── Dockerfile           # Docker образ
├── docker-compose.yml   # Docker Compose конфигурация
├── .env.example         # Пример переменных окружения
├── .gitignore           # Git ignore правила
└── README.md            # Документация
```

## Архитектура

### Поток обработки

```
1. Пользователь отправляет файл
   ↓
2. Бот скачивает файл
   ↓
3. Проверка формата и конвертация (если нужно)
   ↓
4. Отправка на Fireworks Whisper v3 API
   ↓
5. Получение транскрибации
   ↓
6. Отправка транскрибации в OpenAI GPT
   ↓
7. Получение саммари
   ↓
8. Форматирование и отправка ответа
   ↓
9. Очистка временных файлов
```

### Обработка ошибок

- Автоматические ретраи для API запросов (до 3 попыток)
- Exponential backoff между попытками
- Детальное логирование всех ошибок
- Информативные сообщения пользователю при ошибках

## API

### Fireworks Whisper v3

- Endpoint: `https://api.fireworks.ai/inference/v1/audio/transcriptions`
- Метод: POST (multipart/form-data)
- Параметры:
  - `file`: аудио файл
  - `model`: whisper-v3

### OpenAI GPT-4.1-nano

- Используется через официальный OpenAI Python SDK
- Модель: `gpt-4.1-nano`
- Системный промпт настраивается в `config.py`

## Логирование

Все события логируются с указанием:
- Временной метки
- Уровня (DEBUG, INFO, WARNING, ERROR)
- Модуля
- Сообщения

Уровень логирования настраивается через `LOG_LEVEL` в `.env`.

## Безопасность

- ✅ Все токены и ключи хранятся в `.env` (не коммитятся в Git)
- ✅ Валидация конфигурации при запуске
- ✅ Фильтрация по темам (опционально)
- ✅ Очистка временных файлов после обработки

## Производительность

- Асинхронная обработка запросов
- Параллельная работа с несколькими пользователями
- Таймауты для API запросов
- Логирование времени обработки

## Развертывание

### Docker

Рекомендуемый способ развертывания:

```bash
# Production запуск
docker-compose up -d

# Обновление
git pull
docker-compose down
docker-compose build
docker-compose up -d
```

### Без Docker

```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск в фоне (Linux/macOS)
nohup python main.py > bot.log 2>&1 &

# Или используйте systemd, supervisor и т.д.
```

## Мониторинг

Просмотр логов:

```bash
# Docker
docker-compose logs -f

# Без Docker
tail -f bot.log
```

## Устранение неполадок

### Бот не отвечает

1. Проверьте, что бот запущен: `docker-compose ps`
2. Проверьте логи: `docker-compose logs`
3. Убедитесь, что токены в `.env` корректны

### Ошибки конвертации

1. Убедитесь, что ffmpeg установлен
2. Проверьте формат входного файла
3. Проверьте логи для деталей

### Ошибки API

1. Проверьте, что API ключи валидны
2. Проверьте лимиты API
3. Проверьте интернет-соединение

## Лицензия

MIT

## Поддержка

При возникновении проблем создайте issue в репозитории проекта.
